#!/bin/sh

. /etc/rc.d/functions

trap "_exit_" 0 1 2 3 15

_exit_()
{
    ps -o ppid,pid,args \
    | sed -e 's%  *% %g' -e 's%^ %%' -e 's% $%%' \
    | grep "^$$ " \
    | grep '/bin/sleep [^ ]*$' \
    | cut -d ' ' -f 2 \
    | while read pid ; do
        kill $pid
    done

    ps -o ppid,pid,args \
    | sed -e 's%  *% %g' -e 's%^ %%' -e 's% $%%' \
    | grep "^$$ " \
    | grep '/usr/bin/xscreensaver-command -watch$' \
    | cut -d ' ' -f 2 \
    | while read pid ; do
        kill $pid
    done
}

if /usr/bin/test `/usr/bin/id -u` -ne 0 ; then
    exit 1
fi

/bin/sleep 10
if /usr/bin/test -n "`/bin/pidof xscreensaver`" ; then
    /usr/bin/xscreensaver-command -deactivate > /dev/null 2>&1
    /usr/bin/xscreensaver-command -watch 2> /dev/null | while read watch ; do
        state=`/bin/echo ${watch} | /bin/sed -e 's%  *% %g' | /usr/bin/cut -d ' ' -f 1`
        if /usr/bin/test "${state}" = "BLANK" ; then
            # Do not sleep when in MythMusic or MythStream.
            mythfrontend_location=`mm_mythfrontend_networkcontrol "query location"`
            if /usr/bin/test ! "${mythfrontend_location}" = "playmusic"  && \
               /usr/bin/test ! "${mythfrontend_location}" = "mythstream" ; then
                /usr/bin/mm_sleep
                if /usr/bin/test -n "`/bin/pidof xscreensaver`" ; then
                    /usr/bin/xscreensaver-command -deactivate > /dev/null 2>&1
                fi
            fi
        fi
    done
fi

exit 0
