#!/bin/sh

# Only allow one running instance of mm_sleep.
pids=`/bin/pidof mm_sleep`
instances=`/bin/echo ${pids} | /usr/bin/wc -w`
if /usr/bin/test ${instances} -ne 1 ; then
    exit 1
fi

. /etc/rc.d/functions

# Create the state directory for mm_sleep.
/bin/rm -fr   /var/lib/mm_sleep.$$
/bin/mkdir -p /var/lib/mm_sleep.$$

# Turn off any external equipment.
/usr/bin/mm_external power_off

# If MPlayer is running, then exit it.
mm_x_xmacroplay 'xine' 'KeyStr Escape\n'
if /usr/bin/test -n "`/bin/pidof mplayer`" ; then
    /bin/kill `/bin/pidof mplayer`
fi
while /usr/bin/test -n "`/bin/pidof mplayer`" ; do
    /bin/sleep 1
done

# If Xine is running, then exit it.
mm_x_xmacroplay 'xine' 'KeyStr Q\n'
if /usr/bin/test -n "`/bin/pidof xine`" ; then
    /bin/kill `/bin/pidof xine`
fi
while /usr/bin/test -n "`/bin/pidof xine`" ; do
    /bin/sleep 1
done

# If any game emulators are running, then exit them.
/usr/bin/mm_game_exit

# If mythfrontend is running, then return it to the Main Menu using the Network Control interface.
if /usr/bin/test -n "`/bin/pidof mythfrontend`" ; then
    timeout=10
    while /usr/bin/test ${timeout} -gt 0 && \
          /usr/bin/test ! "`mm_mythfrontend_networkcontrol 'query location'`" = "MainMenu" ; do
        mm_mythfrontend_networkcontrol "jump mainmenu" > /dev/null 2>&1
        /bin/sleep 1
        timeout=$((${timeout} - 1))
    done
fi

# Stop LCDd because it can stop working as a result of suspend.
while /usr/bin/test -n "`/bin/pidof LCDd`" ; do
    /bin/touch /var/lib/mm_sleep.$$/LCDd
    /usr/bin/killall LCDd 2> /dev/null
done

# Stop irexec so that the remote button press used to wake up the frontend
# does not suspend the frontend.
while /usr/bin/test -n "`/bin/pidof irexec`" ; do
    /bin/touch /var/lib/mm_sleep.$$/irexec
    /usr/bin/killall irexec 2> /dev/null
done

# Stop X
if /usr/bin/test "x${MM_X_RESTART_ON_SLEEP_ENABLED}" = "xyes" ; then
    mm_x_stop
fi

/bin/echo mem > /sys/power/state

# Start X
if /usr/bin/test "x${MM_X_RESTART_ON_SLEEP_ENABLED}" = "xyes" ; then
    mm_x_start
fi

# If irexec was running before suspend, then restart it.
if /usr/bin/test -e /var/lib/mm_sleep.$$/irexec ; then
    /usr/bin/test -z `/bin/pidof irexec` && /usr/bin/irexec -d /etc/lircrc
    /bin/rm -f /var/lib/mm_sleep.$$/irexec
fi

# If LCDd was running before suspend, then restart it.
if /usr/bin/test -e /var/lib/mm_sleep.$$/LCDd ; then
    /usr/bin/test -z `/bin/pidof LDCd` && /etc/LCDd -c /etc/LCDd.conf
    /bin/rm -f /var/lib/mm_sleep.$$/LCDd
fi

# Turn on any external equipment.
/usr/bin/mm_external power_on

# Remove the state directory for mm_sleep.
/bin/rm -fr   /var/lib/mm_sleep.$$
